@model SIOMS.Models.Product
@{
    ViewData["Title"] = "Edit Product";
    ViewData["Subtitle"] = "Update product information";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

@section HeaderButtons {
    <a href="/Admin/Product/Index" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i> Back to Products
    </a>
    <a href="/Admin/Product/Details/@Model.Id" class="btn btn-outline-info">
        <i class="fas fa-eye me-2"></i> View Details
    </a>
}

<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="card-title mb-0">
                    <i class="fas fa-edit me-2"></i> Edit Product
                </h5>
            </div>
            <div class="card-body">
                <!-- Current Info -->
                <div class="alert alert-info mb-4">
                    <h6><i class="fas fa-info-circle me-2"></i> Current Information</h6>
                    <p class="mb-1"><strong>Product ID:</strong> @Model.Id</p>
                    <p class="mb-1"><strong>SKU:</strong> @(string.IsNullOrEmpty(Model.SKU) ? "Auto-generated" : Model.SKU)</p>
                    <p class="mb-0"><strong>Current Stock:</strong> <span id="currentStockValue">@Model.StockQuantity</span> units</p>
                </div>

                <!-- Validation Summary -->
                @if (!ViewData.ModelState.IsValid)
                {
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i> Please fix the following errors:</h6>
                        <ul class="mb-0">
                            @foreach (var key in ViewData.ModelState.Keys)
                            {
                                // Skip navigation properties
                                if (key != "Category" && key != "Supplier" && key != "StockQuantity")
                                {
                                    foreach (var error in ViewData.ModelState[key].Errors)
                                    {
                                        <li>@error.ErrorMessage</li>
                                    }
                                }
                            }
                        </ul>
                    </div>
                }

                <form method="post" action="/Admin/Product/Edit/@Model.Id" enctype="multipart/form-data" id="editForm">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="Id" value="@Model.Id" />
                    
                    <div class="row">
                        <!-- Left Column: Basic Info -->
                        <div class="col-md-8">
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label for="Name" class="form-label">Product Name *</label>
                                    <input type="text" id="Name" name="Name" 
                                           class="form-control @(ViewData.ModelState["Name"]?.Errors?.Any() == true ? "is-invalid" : "")" 
                                           required value="@Model.Name">
                                    @if (ViewData.ModelState["Name"]?.Errors?.Any() == true)
                                    {
                                        <div class="invalid-feedback">
                                            @ViewData.ModelState["Name"]?.Errors?.First().ErrorMessage
                                        </div>
                                    }
                                    else
                                    {
                                        <small class="text-muted">Required field</small>
                                    }
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label for="SKU" class="form-label">SKU (Optional)</label>
                                    <input type="text" id="SKU" name="SKU" class="form-control"
                                           value="@Model.SKU">
                                    <small class="text-muted">Leave empty for auto-generated SKU</small>
                                </div>
                                
                                <div class="col-12 mb-3">
                                    <label for="Description" class="form-label">Description (Optional)</label>
                                    <textarea id="Description" name="Description" class="form-control" rows="4">@Model.Description</textarea>
                                    <small class="text-muted">Optional field</small>
                                </div>
                            </div>
                            
                            <!-- Image Section (Optional) -->
                            <div class="mb-4">
                                <label class="form-label">Product Image (Optional)</label>
                                <div class="border p-3 rounded">
                                    <!-- Current Image -->
                                    @if (!string.IsNullOrEmpty(Model.ImageUrl))
                                    {
                                        <div class="mb-3 text-center" id="currentImageContainer">
                                            <p><strong>Current Image:</strong></p>
                                            <img src="@Model.ImageUrl" alt="@Model.Name" 
                                                 style="max-width: 200px; max-height: 200px; object-fit: cover; border-radius: 5px;">
                                            <div class="mt-2">
                                                <a href="@Model.ImageUrl" target="_blank" class="btn btn-sm btn-outline-info">
                                                    <i class="fas fa-external-link-alt me-1"></i> View Full
                                                </a>
                                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                                        onclick="removeCurrentImage()">
                                                    <i class="fas fa-trash me-1"></i> Remove Image
                                                </button>
                                            </div>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="mb-3 text-center" id="currentImageContainer">
                                            <p class="text-muted"><i>No image currently</i></p>
                                        </div>
                                    }
                                    
                                    <!-- Image Upload/Change -->
                                    <div id="imageUploadSection">
                                        <div id="imagePreview" class="mb-3 text-center" style="display: none;">
                                            <p><strong>New Image Preview:</strong></p>
                                            <img id="previewImage" src="#" alt="Preview" 
                                                 style="max-width: 200px; max-height: 200px; object-fit: cover; border-radius: 5px;">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="ImageFile" class="form-label">Upload New Image</label>
                                            <input type="file" id="ImageFile" name="ImageFile" 
                                                   class="form-control @(ViewData.ModelState["ImageFile"]?.Errors?.Any() == true ? "is-invalid" : "")" 
                                                   accept="image/*" onchange="previewImage(event)">
                                            @if (ViewData.ModelState["ImageFile"]?.Errors?.Any() == true)
                                            {
                                                <div class="invalid-feedback">
                                                    @ViewData.ModelState["ImageFile"]?.Errors?.First().ErrorMessage
                                                </div>
                                            }
                                            <small class="text-muted">Upload from your device (JPG, PNG, GIF, BMP, WEBP - Max 5MB)</small>
                                        </div>
                                        
                                        <div class="text-center my-2">
                                            <strong class="text-muted">OR</strong>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="ImageUrl" class="form-label">Enter Image URL</label>
                                            <input type="url" id="ImageUrl" name="ImageUrl" 
                                                   class="form-control @(ViewData.ModelState["ImageUrl"]?.Errors?.Any() == true ? "is-invalid" : "")" 
                                                   placeholder="https://example.com/image.jpg"
                                                   value="@Model.ImageUrl">
                                            @if (ViewData.ModelState["ImageUrl"]?.Errors?.Any() == true)
                                            {
                                                <div class="invalid-feedback">
                                                    @ViewData.ModelState["ImageUrl"]?.Errors?.First().ErrorMessage
                                                </div>
                                            }
                                            <small class="text-muted">Enter online image URL (Optional)</small>
                                        </div>
                                        
                                        <div class="alert alert-info mt-3">
                                            <small><i class="fas fa-info-circle me-2"></i> 
                                                <strong>Note:</strong> Both image fields are optional. Leave both empty to keep current image or remove it.
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right Column: Details -->
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="CategoryId" class="form-label">Category *</label>
                                <select id="CategoryId" name="CategoryId" 
                                        class="form-select @(ViewData.ModelState["CategoryId"]?.Errors?.Any() == true ? "is-invalid" : "")" 
                                        required>
                                    <option value="">Select Category</option>
                                    @foreach (var category in ViewBag.Categories)
                                    {
                                        <option value="@category.Id" 
                                                selected="@(Model.CategoryId == category.Id)">
                                            @category.Name
                                        </option>
                                    }
                                </select>
                                @if (ViewData.ModelState["CategoryId"]?.Errors?.Any() == true)
                                {
                                    <div class="invalid-feedback">
                                        @ViewData.ModelState["CategoryId"]?.Errors?.First().ErrorMessage
                                    </div>
                                }
                                else
                                {
                                    <small class="text-muted">Required field</small>
                                }
                            </div>
                            
                            <div class="mb-3">
                                <label for="SupplierId" class="form-label">Supplier *</label>
                                <select id="SupplierId" name="SupplierId" 
                                        class="form-select @(ViewData.ModelState["SupplierId"]?.Errors?.Any() == true ? "is-invalid" : "")" 
                                        required>
                                    <option value="">Select Supplier</option>
                                    @foreach (var supplier in ViewBag.Suppliers)
                                    {
                                        <option value="@supplier.Id" 
                                                selected="@(Model.SupplierId == supplier.Id)">
                                            @supplier.Name
                                        </option>
                                    }
                                </select>
                                @if (ViewData.ModelState["SupplierId"]?.Errors?.Any() == true)
                                {
                                    <div class="invalid-feedback">
                                        @ViewData.ModelState["SupplierId"]?.Errors?.First().ErrorMessage
                                    </div>
                                }
                                else
                                {
                                    <small class="text-muted">Required field</small>
                                }
                            </div>
                            
                            <div class="mb-3">
                                <label for="Price" class="form-label">Price *</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" id="Price" name="Price" 
                                           class="form-control @(ViewData.ModelState["Price"]?.Errors?.Any() == true ? "is-invalid" : "")" 
                                           min="0.01" step="0.01" required
                                           value="@Model.Price.ToString("0.00")">
                                </div>
                                @if (ViewData.ModelState["Price"]?.Errors?.Any() == true)
                                {
                                    <div class="invalid-feedback">
                                        @ViewData.ModelState["Price"]?.Errors?.First().ErrorMessage
                                    </div>
                                }
                                else
                                {
                                    <small class="text-muted">Required field</small>
                                }
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Current Stock</label>
                                <input type="number" class="form-control" value="@Model.StockQuantity" readonly>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-sm btn-warning" id="adjustStockBtn">
                                        <i class="fas fa-exchange-alt me-1"></i> Adjust Stock
                                    </button>
                                </div>
                                <small class="text-muted">Use stock adjustment to change</small>
                            </div>
                            
                            <div class="mb-4">
                                <label for="MinStockLimit" class="form-label">Min Stock Limit *</label>
                                <input type="number" id="MinStockLimit" name="MinStockLimit" 
                                       class="form-control @(ViewData.ModelState["MinStockLimit"]?.Errors?.Any() == true ? "is-invalid" : "")" 
                                       min="0" required
                                       value="@Model.MinStockLimit">
                                @if (ViewData.ModelState["MinStockLimit"]?.Errors?.Any() == true)
                                {
                                    <div class="invalid-feedback">
                                        @ViewData.ModelState["MinStockLimit"]?.Errors?.First().ErrorMessage
                                    </div>
                                }
                                else
                                {
                                    <small class="text-muted">Required field</small>
                                }
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-end gap-2 mt-4">
                        <a href="/Admin/Product/Index" class="btn btn-secondary">
                            <i class="fas fa-times me-2"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-warning" id="submitBtn">
                            <i class="fas fa-save me-2"></i> Update Product
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Stock Adjustment Modal -->
<div class="modal fade" id="stockAdjustModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Adjust Stock</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="stockAdjustForm">
                <div class="modal-body">
                    <input type="hidden" id="adjustProductId" value="@Model.Id">
                    <div class="mb-3">
                        <label class="form-label">Product</label>
                        <input type="text" id="adjustProductName" class="form-control" value="@Model.Name" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Current Stock</label>
                        <input type="number" id="adjustCurrentStock" class="form-control" 
                               value="@Model.StockQuantity" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">New Stock Quantity *</label>
                        <input type="number" id="adjustNewStock" class="form-control" 
                               min="0" value="@Model.StockQuantity" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes (Optional)</label>
                        <textarea id="adjustNotes" class="form-control" rows="3" 
                                  placeholder="Reason for adjustment..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="updateStockBtn">Update Stock</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Image preview function
        function previewImage(event) {
            const reader = new FileReader();
            const imagePreview = document.getElementById('imagePreview');
            const previewImage = document.getElementById('previewImage');
            
            reader.onload = function() {
                previewImage.src = reader.result;
                imagePreview.style.display = 'block';
            }
            
            if (event.target.files[0]) {
                reader.readAsDataURL(event.target.files[0]);
            }
        }
        
        // Remove current image
        function removeCurrentImage() {
            if (confirm('Are you sure you want to remove the current image?')) {
                document.getElementById('ImageUrl').value = '';
                document.getElementById('ImageFile').value = '';
                document.getElementById('currentImageContainer').innerHTML = 
                    '<p class="text-muted"><i>Image will be removed</i></p>';
                
                // Hide image preview if showing
                document.getElementById('imagePreview').style.display = 'none';
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('editForm');
            const submitBtn = document.getElementById('submitBtn');
            
            // Stock adjustment button
            document.getElementById('adjustStockBtn').addEventListener('click', function() {
                const modal = new bootstrap.Modal(document.getElementById('stockAdjustModal'));
                modal.show();
            });
            
            // Stock adjustment form submission
            document.getElementById('stockAdjustForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const productId = document.getElementById('adjustProductId').value;
                const newStock = document.getElementById('adjustNewStock').value;
                const notes = document.getElementById('adjustNotes').value;
                const updateBtn = document.getElementById('updateStockBtn');
                
                // Validate new stock
                if (!newStock || parseInt(newStock) < 0) {
                    alert('Please enter a valid stock quantity (0 or higher)');
                    document.getElementById('adjustNewStock').focus();
                    return;
                }
                
                // Get anti-forgery token
                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                
                // Show loading
                updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Updating...';
                updateBtn.disabled = true;
                
                // Send AJAX request
                fetch(`/Admin/Product/UpdateStock/${productId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': token || '',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ 
                        newStock: parseInt(newStock),
                        notes: notes 
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Update the displayed stock value
                        document.getElementById('currentStockValue').textContent = data.newStock;
                        document.querySelector('input[readonly]').value = data.newStock;
                        document.getElementById('adjustCurrentStock').value = data.newStock;
                        
                        // Close modal and show success message
                        const modal = bootstrap.Modal.getInstance(document.getElementById('stockAdjustModal'));
                        modal.hide();
                        
                        // Show success alert
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
                        alertDiv.innerHTML = `
                            <i class="fas fa-check-circle me-2"></i> ${data.message}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                        document.querySelector('.card-body').insertBefore(alertDiv, document.querySelector('.alert-info'));
                        
                        // Auto-remove alert after 5 seconds
                        setTimeout(() => {
                            if (alertDiv.parentNode) {
                                alertDiv.remove();
                            }
                        }, 5000);
                    } else {
                        alert(data.message || 'Error updating stock');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error updating stock. Please try again.');
                })
                .finally(() => {
                    // Reset button
                    updateBtn.innerHTML = 'Update Stock';
                    updateBtn.disabled = false;
                });
            });
            
            form.addEventListener('submit', function(e) {
                const nameInput = document.getElementById('Name');
                const categorySelect = document.getElementById('CategoryId');
                const supplierSelect = document.getElementById('SupplierId');
                const priceInput = document.getElementById('Price');
                const minStockInput = document.getElementById('MinStockLimit');
                const imageFile = document.getElementById('ImageFile');
                const imageUrl = document.getElementById('ImageUrl');
                
                // Reset previous error states
                document.querySelectorAll('.is-invalid').forEach(el => {
                    el.classList.remove('is-invalid');
                });
                
                let hasError = false;
                
                // Validate required fields
                if (!nameInput.value.trim()) {
                    nameInput.classList.add('is-invalid');
                    nameInput.focus();
                    hasError = true;
                }
                
                if (!categorySelect.value || categorySelect.value === '') {
                    categorySelect.classList.add('is-invalid');
                    if (!hasError) categorySelect.focus();
                    hasError = true;
                }
                
                if (!supplierSelect.value || supplierSelect.value === '') {
                    supplierSelect.classList.add('is-invalid');
                    if (!hasError) supplierSelect.focus();
                    hasError = true;
                }
                
                if (!priceInput.value || parseFloat(priceInput.value) <= 0) {
                    priceInput.classList.add('is-invalid');
                    if (!hasError) priceInput.focus();
                    hasError = true;
                }
                
                if (!minStockInput.value || parseInt(minStockInput.value) < 0) {
                    minStockInput.classList.add('is-invalid');
                    if (!hasError) minStockInput.focus();
                    hasError = true;
                }
                
                // âœ… Validate image: can't have both file and URL
                const hasFile = imageFile.files.length > 0;
                const hasUrl = imageUrl.value.trim() !== '';
                
                if (hasFile && hasUrl) {
                    imageFile.classList.add('is-invalid');
                    imageUrl.classList.add('is-invalid');
                    if (!hasError) imageFile.focus();
                    alert('Please choose only one: upload file OR enter URL, not both');
                    hasError = true;
                }
                
                if (hasError) {
                    e.preventDefault();
                    return false;
                }
                
                // Show loading
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Updating...';
                submitBtn.disabled = true;
            });
            
            // Auto-focus
            document.getElementById('Name').focus();
            
            // Clear validation on input
            document.querySelectorAll('input, select, textarea').forEach(input => {
                input.addEventListener('input', function() {
                    this.classList.remove('is-invalid');
                });
                
                if (input.tagName === 'SELECT') {
                    input.addEventListener('change', function() {
                        this.classList.remove('is-invalid');
                    });
                }
            });
        });
    </script>
}